{% extends 'gestion/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'gestion/css/pos.css' %}">
<style>
    .modo-consumo-group label:has(input:checked) {
        background: #fff5f6 !important;
        border-color: var(--panchita-red) !important;
    }
    .modo-consumo-group label:hover {
        border-color: #adb5bd !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- Left Panel - Order Summary -->
    <div class="order-panel">
        <div class="order-header">
            <h2><i class="fas fa-shopping-cart"></i> Pedido Actual</h2>
            <span class="ticket-number" id="ticketNumberDisplay">Ticket N°{{ siguiente_ticket }}</span>
        </div>

        <div class="order-items-header">
            <span class="col-name">Producto</span>
            <span class="col-qty">Cant.</span>
            <span class="col-price">Precio</span>
            <span class="col-total">Total</span>
            <span class="col-actions" style="text-align: center; width: 40px;">-</span>
        </div>

        <div class="order-items">
            <div class="empty-order">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <p>No hay productos en el pedido</p>
            </div>
        </div>

        <div class="order-total">
            <div class="total-row">
                <span>Subtotal:</span>
                <span class="subtotal-amount">Bs. 0.00</span>
            </div>
            <div class="total-final">
                <span>Precio total</span>
                <span class="total-amount">Bs. 0.00</span>
            </div>
        </div>

        <div class="order-actions">
            <button class="btn-more"><i class="fas fa-ellipsis-h"></i></button>
            <button class="btn-pay"><i class="fas fa-check"></i> Pagar</button>
        </div>
    </div>

    <!-- Right Panel - Products -->
    <div class="products-panel">
        <div class="products-header">
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Todos los productos">
                <button class="btn-search"><i class="fas fa-search"></i></button>
                <button class="btn-search"><i class="fas fa-barcode"></i></button>
                {% if user.is_staff %}
                <a href="{% url 'admin:gestion_promocion_changelist' %}" target="_blank" class="btn-promo" title="Gestionar promociones">
                    <i class="fas fa-tags"></i> Promociones
                </a>
                {% endif %}
            </div>

            <div class="category-tabs">
                <button class="category-tab active" data-category="all">Todos</button>
                {% for categoria in categorias %}
                <button class="category-tab" data-category="{{ categoria.id }}">{{ categoria.nombre }}</button>
                {% endfor %}
            </div>
        </div>

        <div class="products-grid">
            {% for item in productos_con_precio %}
            <div class="product-card" data-product-id="{{ item.producto.id }}" data-product-name="{{ item.producto.nombre }}"
                data-product-price="{{ item.precio_display|floatformat:2 }}" data-category="{{ item.producto.categoria.id }}"
                style="display: flex; flex-direction: column; overflow: visible; position: relative;">
                {% if item.tiene_promo %}<span class="promo-badge">PROMO</span>{% endif %}
                <div style="width: 100%; height: 130px; min-height: 130px; max-height: 130px; flex-shrink: 0; overflow: hidden; border-radius: 8px 8px 0 0;">
                    {% if item.producto.imagen %}
                    <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" 
                         style="width: 100%; height: 130px; object-fit: cover; display: block;">
                    {% else %}
                    <div style="width: 100%; height: 130px; background: linear-gradient(135deg, #c41e3a 0%, #9a1830 100%); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-drumstick-bite" style="font-size: 3rem; color: #f8d210; opacity: 0.9;"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="product-info" style="display: flex !important; visibility: visible !important; opacity: 1 !important; padding: 10px !important; background: white !important; flex-shrink: 0; min-height: 50px; width: 100%; box-sizing: border-box; border-top: 1px solid #eee; border-radius: 0 0 8px 8px;">
                    <div class="product-name" style="display: block !important; visibility: visible !important; font-size: 0.85rem; font-weight: 600; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ item.producto.nombre }}</div>
                    <div class="product-price-tag" style="display: block !important; visibility: visible !important; font-size: 0.85rem; font-weight: 700; color: #2c3e50; margin-left: 8px; white-space: nowrap;">Bs. {{ item.precio_display|floatformat:2 }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="payment-modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-cash-register"></i> Procesar Pago</h3>
            <button class="modal-close" onclick="pos.closePaymentModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="payment-summary">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span class="modal-subtotal">Bs. 0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total a Pagar:</span>
                    <span class="modal-total">Bs. 0.00</span>
                </div>
            </div>

            <form id="paymentForm">
                <div class="form-group modo-consumo-group" style="margin-bottom: 1.25rem;">
                    <label>¿Cómo desea el pedido?</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.6rem 1rem; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6; flex: 1; transition: all 0.2s;">
                            <input type="radio" name="modo_consumo" value="local" checked style="accent-color: var(--panchita-red);">
                            <i class="fas fa-utensils" style="color: var(--panchita-red);"></i>
                            <span>En el local</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.6rem 1rem; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6; flex: 1; transition: all 0.2s;">
                            <input type="radio" name="modo_consumo" value="llevar" style="accent-color: var(--panchita-red);">
                            <i class="fas fa-shopping-bag" style="color: var(--panchita-red);"></i>
                            <span>Para llevar</span>
                        </label>
                    </div>
                </div>
                <div class="form-group cliente-group">
                    <label>Cliente *</label>
                    <button type="button" id="btnVentaMostrador" class="btn-venta-mostrador" title="Venta rápida sin buscar cliente">
                        <i class="fas fa-store"></i> Venta Mostrador
                    </button>
                    <div class="cliente-combo" style="display: flex; gap: 0.5rem; align-items: stretch;">
                        <div class="cliente-search-wrap" style="flex: 1; position: relative;">
                            <input type="text" id="cliente_search" class="form-control" placeholder="Buscar cliente por nombre, teléfono o CI..." 
                                   autocomplete="off" style="width: 100%;">
                            <input type="hidden" name="cliente_id" id="cliente_id_hidden" value="">
                            <div id="cliente_dropdown" class="cliente-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 2px; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10;"></div>
                        </div>
                        <button type="button" id="btnNuevoCliente" class="btn-add-cliente" title="Crear cliente nuevo" style="width: 44px; min-width: 44px; padding: 0; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 1.5rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1;">+</button>
                    </div>
                    <div id="nuevoClienteForm" class="nuevo-cliente-form" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <div style="font-weight: 600; margin-bottom: 0.75rem; color: #333;">Datos del nuevo cliente</div>
                        <div style="margin-bottom: 0.5rem;">
                            <input type="text" id="nuevo_cliente_nombre" placeholder="Nombre completo *" maxlength="150" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <input type="text" id="nuevo_cliente_telefono" placeholder="Teléfono" maxlength="20" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <input type="text" id="nuevo_cliente_ci" placeholder="CI / NIT (opcional)" maxlength="20" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <input type="email" id="nuevo_cliente_email" placeholder="Email (opcional)" maxlength="254" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" id="btnGuardarCliente" class="btn-guardar-cliente" style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-save"></i> Guardar cliente
                            </button>
                            <button type="button" id="btnCancelarCliente" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="metodo_pago_select">Método de Pago *</label>
                    <select id="metodo_pago_select" name="metodo_pago_id" required>
                        <option value="">Seleccione método de pago</option>
                        {% for metodo in metodos_pago %}
                        <option value="{{ metodo.id }}">{{ metodo.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="pos.closePaymentModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn-confirm">
                        <i class="fas fa-check"></i> Confirmar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Venta Completada -->
<div id="ventaCompletadaModal" class="payment-modal" style="display: none;">
    <div class="modal-overlay" onclick="pos.closeVentaCompletadaModal()"></div>
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header" style="border-radius: 15px 15px 0 0;">
            <h3><i class="fas fa-check-circle"></i> Venta Completada</h3>
        </div>
        <div class="modal-body" style="text-align: center; padding: 2rem;">
            <div style="font-size: 4rem; color: #28a745; margin-bottom: 1rem;">
                <i class="fas fa-check-circle"></i>
            </div>
            <p style="font-size: 1.2rem; margin-bottom: 0.5rem; color: #333;">Venta <strong id="ventaCompletadaId">#0</strong> registrada</p>
            <p style="font-size: 1.5rem; font-weight: 700; color: #c41e3a; margin: 1rem 0;">Bs. <span id="ventaCompletadaTotal">0.00</span></p>
            <button type="button" onclick="pos.closeVentaCompletadaModal()" class="btn-confirm" style="width: 100%; margin-top: 1rem;">
                <i class="fas fa-thumbs-up"></i> Aceptar
            </button>
        </div>
    </div>
</div>

<style>
    .payment-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        position: relative;
        max-width: 500px;
        margin: 5% auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: linear-gradient(135deg, #c41e3a 0%, #9a1830 100%);
        border-radius: 15px 15px 0 0;
        border-bottom: 3px solid #f8d210;
    }

    .modal-header h3 {
        margin: 0;
        color: white;
        font-size: 1.3rem;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: white;
        transition: transform 0.2s;
    }

    .modal-close:hover {
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 2rem;
    }

    .payment-summary {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    .summary-row.total {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #c41e3a;
        font-size: 1.3rem;
        font-weight: bold;
        color: #c41e3a;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }

    .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .form-group select:focus {
        outline: none;
        border-color: #c41e3a;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-cancel,
    .btn-confirm {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    .btn-confirm {
        background: linear-gradient(135deg, #c41e3a 0%, #9a1830 100%);
        color: white;
        border: 2px solid #f8d210;
    }

    .btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(196, 30, 58, 0.4);
    }

    .btn-add-cliente:hover {
        background: #218838;
        transform: scale(1.05);
    }
    .cliente-dropdown-item {
        padding: 0.6rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        font-size: 0.95rem;
        transition: background 0.15s;
    }
    .cliente-dropdown-item:last-child { border-bottom: none; }
    .cliente-dropdown-item:hover {
        background: #f0f0f0;
    }
    .cliente-dropdown-empty {
        padding: 0.75rem 1rem;
        color: #666;
        font-size: 0.9rem;
    }
    .btn-venta-mostrador {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        margin-bottom: 0.75rem;
        background: var(--panchita-yellow, #f8d210);
        color: var(--panchita-dark, #2c3e50);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-venta-mostrador:hover {
        background: #f4c430;
        transform: translateY(-1px);
    }
    .promo-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--panchita-yellow);
        color: var(--panchita-dark);
        font-size: 0.7rem;
        font-weight: 700;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        z-index: 2;
    }
    .btn-promo {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.5rem 0.9rem;
        background: var(--panchita-yellow);
        color: var(--panchita-dark);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-promo:hover {
        background: #f4c430;
        color: var(--panchita-dark);
        transform: translateY(-1px);
    }
</style>

{% csrf_token %}
{% endblock %}

{% block scripts %}
<script>
    // Pass data to JavaScript
    window.posData = {
        procesarPagoUrl: "{% url 'pos_procesar_pago' %}",
        buscarClientesUrl: "{% url 'pos_buscar_clientes' %}",
        crearClienteUrl: "{% url 'pos_crear_cliente' %}",
        csrfToken: "{{ csrf_token }}",
        siguienteTicket: {{ siguiente_ticket }},
        clienteMostradorId: {{ cliente_mostrador.id }}
    };
</script>
<script src="{% static 'gestion/js/pos.js' %}"></script>
{% endblock %}