{% extends 'gestion/base.html' %}
{% block content %}
<h2>Nueva Venta</h2>
<form method="post" class="card card-custom p-4">
    {% csrf_token %}
    <div class="mb-3">
        <label>Cliente</label>
        <select name="cliente_id" class="form-select" required>
            <option value="">Seleccionar Cliente</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}">{{ cliente.nombre_completo }}</option>
            {% endfor %}
        </select>
    </div>

    <h4>Productos <button type="button" class="btn btn-sm btn-secondary" id="add-item"><i class="fas fa-plus"></i>
            Agregar</button></h4>
    <div id="items-container">
        <div class="row mb-2 item-row">
            <div class="col-8">
                <select name="productos[]" class="form-select">
                    <option value="">Seleccionar Producto</option>
                    {% for p in productos %}
                    <option value="{{ p.id }}">{{ p.nombre }} - Bs. {{ p.precio_final }} {% if p.descuento > 0 %}({{
                        p.descuento }}% desc.){% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-3">
                <input type="number" name="cantidades[]" class="form-control" placeholder="Cant" value="1" min="1">
            </div>
            <div class="col-1">
                <button type="button" class="btn btn-danger btn-sm remove-item"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>

    <div class="mb-3 mt-3">
        <label>Método de Pago</label>
        <select name="metodo_pago_id" class="form-select" required>
            <option value="">Seleccionar Método de Pago</option>
            {% for metodo in metodos_pago %}
            <option value="{{ metodo.id }}">{{ metodo.nombre }} {% if metodo.requiere_validacion %}(Requiere
                validación){% endif %}</option>
            {% endfor %}
        </select>
    </div>

    <button type="submit" class="btn btn-success mt-3">Finalizar Venta</button>
    <a href="{% url 'index' %}" class="btn btn-secondary mt-3">Cancelar</a>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('add-item').addEventListener('click', function () {
            var container = document.getElementById('items-container');
            var row = container.querySelector('.item-row').cloneNode(true);
            row.querySelector('input').value = 1;
            row.querySelector('select').value = "";
            container.appendChild(row);
        });

        document.getElementById('items-container').addEventListener('click', function (e) {
            if (e.target.closest('.remove-item')) {
                var rows = document.querySelectorAll('.item-row');
                if (rows.length > 1) {
                    e.target.closest('.item-row').remove();
                }
            }
        });
    });
</script>
{% endblock %}