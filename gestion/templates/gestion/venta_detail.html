{% extends 'gestion/base.html' %}
{% load static %}
{% load gestion_extras %}

{% block extra_css %}
<style>
    .venta-detail-wrapper {
        max-width: 700px;
        margin: 0 auto;
        padding: 2rem;
    }
    .venta-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        background: var(--panchita-red);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s;
    }
    .btn-back:hover { background: var(--panchita-red-dark); color: white; }
    .btn-confirmar-pago {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.8rem;
        background: #28a745;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
    }
    .btn-confirmar-pago:hover { background: #218838; color: white; }
    /* Ticket estilo factura pequeña - un solo bloque */
    .ticket-factura {
        background: white;
        border: 2px solid #333;
        border-radius: 4px;
        padding: 1.5rem 2rem;
        max-width: 380px;
        margin: 0 auto;
        font-family: 'Courier New', monospace;
    }
    .ticket-factura .ticket-header {
        text-align: center;
        border-bottom: 2px dashed #333;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }
    .ticket-factura .ticket-empresa {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .ticket-factura .ticket-numero {
        font-size: 2.5rem;
        font-weight: 700;
        letter-spacing: 3px;
        margin: 0.5rem 0 0 0;
    }
    .ticket-factura .ticket-row {
        display: flex;
        justify-content: space-between;
        padding: 0.35rem 0;
        font-size: 0.95rem;
    }
    .ticket-factura .ticket-row .label { color: #555; }
    .ticket-factura .ticket-row .value { font-weight: 600; }
    .ticket-factura .ticket-divider {
        border-top: 1px dashed #999;
        margin: 0.75rem 0;
    }
    .ticket-factura .items-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    .ticket-factura .items-table td {
        padding: 0.4rem 0.25rem;
        border-bottom: 1px dotted #ccc;
    }
    .ticket-factura .items-table .text-right { text-align: right; }
    .ticket-factura .total-row {
        font-weight: 700;
        font-size: 1.15rem;
        padding: 0.75rem 0;
        border-top: 2px solid #333;
        margin-top: 0.5rem;
    }
    .ticket-factura .estado-badge {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .estado-completado { background: #d4edda; color: #155724; }
    .estado-pendiente { background: #fff3cd; color: #856404; }
    .estado-cancelado { background: #f8d7da; color: #721c24; }
    .print-only { display: none !important; }
    @media print {
        body * { visibility: hidden; }
        .ticket-print-area, .ticket-print-area * { visibility: visible; }
        .ticket-print-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            padding: 1rem;
            background: white;
        }
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        .ticket-factura .col-accion { display: none !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="venta-detail-wrapper ticket-print-area">
    <div class="venta-detail-header no-print">
        <h2 style="margin: 0; color: var(--panchita-dark);">Detalle de venta {% if venta.tipo_documento == 'factura' %}(Factura){% endif %}</h2>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button type="button" onclick="imprimirTicket()" class="btn-back" style="cursor: pointer; border: none;">
                <i class="fas fa-print"></i> Imprimir {% if venta.tipo_documento == 'factura' %}Factura{% else %}Ticket{% endif %}
            </button>
            <a href="{% url 'venta_index' %}" class="btn-back">
                <i class="fas fa-arrow-left"></i> Volver a Ventas
            </a>
        </div>
    </div>

    <!-- Ticket o Factura - un solo bloque -->
    <div class="ticket-factura">
        <div class="ticket-header">
            <div class="ticket-empresa">{{ empresa.nombre|default:"Pollos Panchita" }}</div>
            {% if empresa.nit %}<div class="ticket-row" style="justify-content: center; padding: 0.2rem 0;"><span class="label">NIT:</span><span class="value">{{ empresa.nit }}</span></div>{% endif %}
            <div class="ticket-numero">{% if venta.tipo_documento == 'factura' %}FACTURA N° {{ venta.numero_factura }}{% else %}TICKET #{{ venta.id }}{% endif %}</div>
        </div>

        <div class="ticket-row">
            <span class="label">Fecha:</span>
            <span class="value">{{ venta.fecha|date:"d/m/Y H:i" }}</span>
        </div>
        <div class="ticket-row">
            <span class="label">Cliente:</span>
            <span class="value">{{ venta.cliente.nombre_completo }}</span>
        </div>
        {% if venta.tipo_documento == 'factura' and venta.cliente.ci_nit %}
        <div class="ticket-row">
            <span class="label">NIT/CI:</span>
            <span class="value">{{ venta.cliente.ci_nit }}</span>
        </div>
        {% if venta.cliente.direccion %}
        <div class="ticket-row">
            <span class="label">Dirección:</span>
            <span class="value">{{ venta.cliente.direccion }}</span>
        </div>
        {% endif %}
        {% endif %}
        <div class="ticket-row">
            <span class="label">Vendedor:</span>
            <span class="value">{{ venta.usuario.get_full_name|default:venta.usuario.username }}</span>
        </div>
        <div class="ticket-row">
            <span class="label">Modo:</span>
            <span class="value">
                {% if venta|modo_consumo_safe == 'llevar' %}Para llevar{% else %}En el local{% endif %}
            </span>
        </div>
        <div class="ticket-row">
            <span class="label">Estado:</span>
            <span><span class="estado-badge estado-{{ venta.estado }}">{{ venta.get_estado_display }}</span></span>
        </div>

        <div class="ticket-divider"></div>

        <table class="items-table">
            <thead>
                <tr>
                    <th style="text-align: left; padding: 0.4rem 0.25rem; border-bottom: 1px solid #333;">Producto</th>
                    <th class="text-right" style="border-bottom: 1px solid #333;">Cant.</th>
                    <th class="text-right" style="border-bottom: 1px solid #333;">P.Unit</th>
                    <th class="text-right" style="border-bottom: 1px solid #333;">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for detalle in venta.detalles.all %}
                <tr>
                    <td>{{ detalle.producto.nombre }}</td>
                    <td class="text-right">{{ detalle.cantidad }}</td>
                    <td class="text-right">Bs. {{ detalle.precio_unitario|floatformat:2 }}</td>
                    <td class="text-right">Bs. {{ detalle.subtotal|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="total-row" style="display: flex; justify-content: space-between; align-items: center;">
            <span>TOTAL</span>
            <span>Bs. {{ venta.total|floatformat:2 }}</span>
        </div>

        {% if venta.pagos.exists %}
        <div class="ticket-divider"></div>
        <div style="font-size: 0.9rem;">
            <strong>Pagos:</strong>
            {% for pago in venta.pagos.all %}
            <div class="ticket-row">
                <span>{{ pago.metodo_pago.nombre }}</span>
                <span>Bs. {{ pago.monto|floatformat:2 }}{% if pago.validado %} ✓{% endif %}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="no-print ticket-divider" style="margin-top: 1rem;"></div>
        {% if venta.pagos.exists %}
        {% for pago in venta.pagos.all %}
        {% if not pago.validado %}
        <div class="no-print" style="margin-top: 0.5rem;">
            <form method="post" action="{% url 'pago_validar' venta.pk pago.pk %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn-confirmar-pago" title="Confirmar pago">
                    <i class="fas fa-check"></i> Confirmar pago {{ pago.metodo_pago.nombre }}
                </button>
            </form>
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function imprimirTicket() {
    window.print();
}
</script>
{% endblock %}
